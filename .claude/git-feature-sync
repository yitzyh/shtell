#!/bin/bash

# Claude Code slash command: /git-feature-sync
# Full workflow: commit current work â†’ merge main into current branch â†’ merge current branch to main â†’ return to feature branch

set -e  # Exit on any error

echo "ğŸš€ Git Feature Sync Workflow"
echo "============================="

current_branch=$(git branch --show-current)
current_path=$(pwd)

# Validate we're not on main
if [ "$current_branch" = "main" ]; then
    echo "âŒ Error: You're currently on main branch. Switch to a feature branch first."
    exit 1
fi

echo "ğŸ“ Starting sync from: $current_branch"
echo "ğŸ“‚ In worktree: $current_path"
echo ""

# Step 1: Check and commit current work
echo "ğŸ” Step 1: Checking for uncommitted changes..."
if [ -n "$(git status --porcelain)" ]; then
    echo "ğŸ“ Found uncommitted changes. Creating commit..."
    git add -A
    
    # Prompt for commit message
    echo ""
    echo "ğŸ’¬ Enter commit message (or press Enter for auto-generated message):"
    read -r commit_message
    
    if [ -z "$commit_message" ]; then
        commit_message="WIP: Auto-commit before sync - $(date '+%Y-%m-%d %H:%M')"
        echo "ğŸ“ Using auto-generated message: $commit_message"
    fi
    
    git commit -m "$commit_message"
    echo "âœ… Changes committed successfully"
else
    echo "âœ… Working tree is clean"
fi

echo ""

# Step 2: Find and switch to main worktree
echo "ğŸ”„ Step 2: Switching to main worktree..."
main_worktree=$(git worktree list | grep '\[main\]' | awk '{print $1}')

if [ -z "$main_worktree" ]; then
    echo "âŒ Error: Could not find main worktree"
    exit 1
fi

echo "ğŸ“‚ Main worktree found at: $main_worktree"
cd "$main_worktree"
echo "âœ… Switched to main worktree"

# Step 3: Update main branch
echo ""
echo "ğŸ“¥ Step 3: Updating main branch..."
git checkout main
git pull origin main || echo "âš ï¸ Could not pull from origin (continuing anyway)"
echo "âœ… Main branch updated"

# Step 4: Merge feature branch into main
echo ""
echo "ğŸ”€ Step 4: Merging $current_branch into main..."
git merge "$current_branch" --no-edit || {
    echo "âŒ Merge failed. You may need to resolve conflicts manually."
    echo "ğŸ  You are now in the main worktree: $main_worktree"
    exit 1
}
echo "âœ… Feature branch merged into main"

# Step 5: Push main to origin
echo ""
echo "ğŸ“¤ Step 5: Pushing main to origin..."
git push origin main || echo "âš ï¸ Could not push to origin (you may need to push manually)"
echo "âœ… Main branch pushed"

# Step 6: Return to feature worktree and update
echo ""
echo "ğŸ  Step 6: Returning to feature worktree..."
cd "$current_path"
echo "âœ… Back in feature worktree: $current_path"

# Step 7: Update feature branch with latest main
echo ""
echo "ğŸ”„ Step 7: Updating feature branch with latest main..."
git pull origin main --no-edit || echo "âš ï¸ Could not pull main into feature branch"
echo "âœ… Feature branch updated with latest main"

echo ""
echo "ğŸ‰ Sync Complete!"
echo "=================="
echo "âœ… Feature '$current_branch' has been successfully synced with main"
echo "âœ… Main branch contains your feature changes"
echo "âœ… You're back on your feature branch for continued development"
echo ""
echo "ğŸ“Š Current status:"
git log --oneline -3 --decorate